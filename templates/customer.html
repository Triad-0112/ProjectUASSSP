<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Customers</title>
</head>
<body class="bg-gray-100">
    <!-- Navbar -->
    <nav class="bg-gray-800 p-4">
        <div class="container mx-auto flex items-center">
            <!-- Logo -->
            <a href="#" class="flex items-center mr-4">
                <img src="/public/assets/logo.png" alt="Logo" class="h-10 w-auto">
            </a>
            <!-- Navigation Links -->
            <div class="flex-grow flex justify-between items-center">
                <div class="flex space-x-4">
                    <a href="/dashboard" class="text-white text-sm font-semibold">Home</a>
                    <a href="/contract" class="text-white text-sm font-semibold">Contract</a>
                    <a href="/invoice" class="text-white text-sm font-semibold">Invoice</a>
                    <a href="/customer" class="text-white text-sm font-semibold">Customer</a>
                </div>
                <button onclick="logout()" class="text-white text-sm font-semibold">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto p-6">
        <h1 class="text-3xl font-bold mb-4">Customer Page</h1>

        <!-- Create Customer Form -->
        <div class="bg-white shadow-md rounded-lg p-4 mb-4">
            <h2 class="text-2xl font-semibold mb-4">Add Customer</h2>
            <form id="create-customer-form">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="create-name">Name</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="create-name" type="text" placeholder="Name">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="create-email">Email</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="create-email" type="email" placeholder="Email">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="create-phone">Phone</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="create-phone" type="text" placeholder="Phone">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="create-street">Street</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="create-street" type="text" placeholder="Street">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="create-city">City</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="create-city" type="text" placeholder="City">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="create-province">Province</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="create-province" type="text" placeholder="Province">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="create-zip">Zip</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="create-zip" type="text" placeholder="Zip">
                </div>
                <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="button" onclick="createCustomer()">Add Customer</button>
            </form>
        </div>

        <!-- Customers List -->
        <div id="customers-container" class="bg-white shadow-md rounded-lg p-4 overflow-x-auto">
            <h2 class="text-2xl font-semibold mb-4">All Customers</h2>
            <div id="customers-list"></div>
        </div>

        <!-- Update Customer Form (Hidden by Default) -->
        <div id="update-customer-form-container" class="bg-white shadow-md rounded-lg p-4 mb-4 hidden">
            <h2 class="text-2xl font-semibold mb-4">Update Customer</h2>
            <form id="update-customer-form" onsubmit="updateCustomer(event)">
                <input type="hidden" id="update-id">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="update-name">Name</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="update-name" type="text" placeholder="Name">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="update-email">Email</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="update-email" type="email" placeholder="Email">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="update-phone">Phone</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="update-phone" type="text" placeholder="Phone">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="update-street">Street</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="update-street" type="text" placeholder="Street">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="update-city">City</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="update-city" type="text" placeholder="City">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="update-province">Province</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="update-province" type="text" placeholder="Province">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="update-zip">Zip</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="update-zip" type="text" placeholder="Zip">
                </div>
                <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="submit">Update Customer</button>
            </form>
        </div>
    </div>

    <script>
        async function fetchCustomers() {
            try {
                const response = await fetch('/customers', {
                    method: 'GET',
                    credentials: 'same-origin' // Include cookies in the request
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const customers = await response.json();
                console.log('Customers:', customers); // Log customers data for debugging

                const customersList = document.getElementById('customers-list');
                if (!customersList) {
                    console.error('customers-list element not found');
                    return;
                }

                customersList.innerHTML = '';

                if (!Array.isArray(customers) || customers.length === 0) {
                    customersList.innerHTML = '<p>No customers found.</p>';
                    return;
                }

                customersList.innerHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created At</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${generateCustomersTable(customers)}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error fetching customers:', error);
            }
        }

        function generateCustomersTable(customers) {
            return customers.map(customer => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">${customer.ID}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${customer.Name}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${customer.Email}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${customer.Phone}</td>
                    <td class="px-6 py-4 whitespace-normal break-words">
                        ${customer.Address.Street}, ${customer.Address.City}, ${customer.Address.Province}, ${customer.Address.Zip}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">${new Date(customer.CreatedAt).toLocaleDateString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button class="text-blue-500 hover:text-blue-700" onclick="editCustomer('${customer.ID}')">Edit</button>
                        <button class="text-red-500 hover:text-red-700 ml-2" onclick="deleteCustomer('${customer.ID}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        async function createCustomer() {
            const name = document.getElementById('create-name').value;
            const email = document.getElementById('create-email').value;
            const phone = document.getElementById('create-phone').value;
            const street = document.getElementById('create-street').value;
            const city = document.getElementById('create-city').value;
            const province = document.getElementById('create-province').value;
            const zip = document.getElementById('create-zip').value;

            const customer = {
                Name: name,
                Email: email,
                Phone: phone,
                Address: {
                    Street: street,
                    City: city,
                    Province: province,
                    Zip: zip
                },
                CreatedAt: new Date().toISOString()
            };

            try {
                const response = await fetch('/customer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin', // Include cookies in the request
                    body: JSON.stringify(customer)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                await fetchCustomers();
            } catch (error) {
                console.error('Error creating customer:', error);
            }
        }

        function updateCustomer(event) {
            event.preventDefault();

            const id = document.getElementById('update-id').value;

            if (!id) {
                console.error('Customer ID is missing.');
                return;
            }

            const updatedCustomer = {
                ID: id,
                Name: document.getElementById('update-name').value,
                Email: document.getElementById('update-email').value,
                Phone: document.getElementById('update-phone').value,
                Address: {
                    Street: document.getElementById('update-street').value,
                    City: document.getElementById('update-city').value,
                    Province: document.getElementById('update-province').value,
                    Zip: document.getElementById('update-zip').value
                }
            };

            console.log('Updating customer with data:', updatedCustomer); // Debugging

            fetch(`/customer/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin', // Include cookies in the request
                body: JSON.stringify(updatedCustomer)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Customer updated:', data);
                // Hide the update form
                document.getElementById('update-customer-form-container').classList.add('hidden');
                // Optionally refresh the customer list or provide feedback to the user
                fetchCustomers();
            })
            .catch(error => {
                console.error('Error updating customer:', error);
            });
        }


        function editCustomer(id) {
            fetch(`/customer/${id}`, {
                method: 'GET',
                credentials: 'same-origin' // Include cookies in the request
            })
            .then(response => response.json())
            .then(customers => {
                console.log('Fetched customer:', customers); // Debugging
                // Fetch the current values from the form inputs
                const currentName = document.getElementById('update-name').value;
                const currentEmail = document.getElementById('update-email').value;
                const currentPhone = document.getElementById('update-phone').value;
                const currentStreet = document.getElementById('update-street').value;
                const currentCity = document.getElementById('update-city').value;
                const currentProvince = document.getElementById('update-province').value;
                const currentZip = document.getElementById('update-zip').value;

                const customer = customers.find(cust => cust.ID === id)

                if (!customer) {
                    console.error('Customer not found.');
                    return;
                }

                // Populate the form inputs with the fetched data or retain current values if data is missing
                document.getElementById('update-id').value = customer.ID || '';
                console.log('Customer ID: ',document.getElementById('update-id').value )
                document.getElementById('update-name').value = customer.Name || currentName;
                document.getElementById('update-email').value = customer.Email || currentEmail;
                document.getElementById('update-phone').value = customer.Phone || currentPhone;

                if (customer.Address) {
                    document.getElementById('update-street').value = customer.Address.Street || currentStreet;
                    document.getElementById('update-city').value = customer.Address.City || currentCity;
                    document.getElementById('update-province').value = customer.Address.Province || currentProvince;
                    document.getElementById('update-zip').value = customer.Address.Zip || currentZip;
                } else {
                    document.getElementById('update-street').value = currentStreet;
                    document.getElementById('update-city').value = currentCity;
                    document.getElementById('update-province').value = currentProvince;
                    document.getElementById('update-zip').value = currentZip;
                }

                document.getElementById('update-customer-form-container').classList.remove('hidden');
            })
            .catch(error => console.error('Error fetching customer:', error));
        }

        async function deleteCustomer(id) {
            try {
                const response = await fetch(`/customer/${id}`, {
                    method: 'DELETE',
                    credentials: 'same-origin' // Include cookies in the request
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                await fetchCustomers();
            } catch (error) {
                console.error('Error deleting customer:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', fetchCustomers);

        function logout() {
            fetch('/logout', {
                method: 'GET',
                credentials: 'same-origin' // Include cookies in the request
            })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                }
            })
            .catch(error => {
                console.error('Error during logout:', error);
            });
        }
    </script>
</body>
<footer class="bg-gray-800 p-4 mt-8">
    <div class="container mx-auto text-center text-white text-sm">
        <p>Copyright &copy; 2024 by Panji Tri Wahyudi (22201050). HTML to backend by Aulia Rizky Fadhilah (22201069). Institut Teknologi dan Bisnis Asia Malang</p>
    </div>
</footer>
</html>
